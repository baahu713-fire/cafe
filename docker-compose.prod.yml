version: '3.8'

# Define the secrets to be read from files on the host.
secrets:
  db_user:
    file: ./db_user.txt
  db_password:
    file: ./db_password.txt
  db_name:
    file: ./db_name.txt

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    ports:
      - "5000:5000"
    # This ensures the container can reach the host machine's services.
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # Mount the secrets as files into the container at /run/secrets/
    secrets:
      - db_user
      - db_password
      - db_name

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    ports:
      - "80:80"
    depends_on:
      - backend
